class t{static counter=0;children=[];watchers=[];actions=new Map;objects=new Map;constructor(t,e){this.id=t,this.parent=e,t=t||0}setObject(e,i){const s=t.sanitize(e);i.uuid||(i.uuid=t.uuidv4()),this.objects.set(s,i)}getObject(e){const i=t.sanitize(e),s=this.objects.get(i);return s||void 0}setAction(t,e){this.actions.set(t,e)}execAction(t){const e=this.objects.get(t),i=this.actions.get(t);i&&i(e)}subscribe(e){e.name=t.sanitize(e.name),this.watchers.push(e)}new(){t.counter++;const e=new t(t.counter,this);return this.children.push(e),e}destroy(){const t=this.parent?.children;t&&t.splice(t.indexOf(this),1)}digest(){for(let e=0;e<this.watchers.length;e++){const i=this.watchers[e],s=this.getObject(i.name);s&&!t.equals(s,i.last)&&(i.last=t.clone(s),i.callback(s))}for(let t=0;t<this.children.length;t++)this.children[t].digest()}static equals(t,e){return JSON.stringify(t)===JSON.stringify(e)}static get(t,e){const i=e.trim().split(".");let s=e,n="";return i.length>0&&(s=i[0],n=i[1]),n&&n.length>0?t[n]:t.value}static set(t,e,i){const s=e.trim().split(".");let n=e,c="";return s.length>0&&(n=s[0],c=s[1]),c&&c.length>0?t[c]=i:t.value=i,t}static sanitize(t){return t.trim().split(".")[0]}static uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}static clone(t){try{return JSON.parse(JSON.stringify(t))}catch(t){return}}}class e{_directives=new Map;_controller=new Map;_root=new t;static instance(){return e._instance||(e._instance=new e),e._instance}controller(t,e){this._controller.set(t,e)}directive(t,e){this._directives.set(t,e)}get(t){return this._directives.get(t)}invoke(t){const e=this._controller.get(t);e&&e(this._root)}root(){return this._root}}class i{}class s{static initialized=!1;static bootstrap(){s.initialized||s.initialize(),this.compile(document.children[0],e.instance().root())}static callDirectives(t,i){for(let s=0;s<t.attributes.length;s++){const n=t.attributes[s],c=e.instance().get(n.name);c&&t instanceof HTMLElement&&c.link(t,i,n.value)}}static compile(t,e){this.callDirectives(t,e);for(let i=0;i<t.children.length;i++){const s=t.children.item(i);null!==s&&this.compile(s,e)}}static initialize(){e.instance().directive("sqt-repeat",{scope:!1,link:(e,i,n)=>{let c=[];const r=n.split("in"),o=r[1].trim(),l=r[0].trim(),a=e.parentNode,d=n=>{for(;a&&a.firstChild;)a.removeChild(a.firstChild);for(let t=0;t<c.length;t++)c[t].destroy();c=[];const r=t.get(n,o);if(Array.isArray(r))for(const t of r){const n=e.cloneNode(!0);n.removeAttribute("sqt-repeat");const r=i.new();c.push(r),r.setObject(l,t),a&&a.appendChild(n),s.compile(n,r)}};i.subscribe({name:o,callback:t=>{t&&d(t)}});const h=i.getObject(o);h&&d(h)}}),e.instance().directive("sqt-controller",{scope:!1,link:(t,i,s)=>{e.instance().invoke(s)}}),e.instance().directive("sqt-bind",{scope:!1,link:(e,i,s)=>{i.subscribe({name:s,callback:i=>{i&&(e.innerHTML=t.get(i,s)||"")}});const n=i.getObject(s);n&&(e.innerHTML=t.get(n,s)||"")}}),e.instance().directive("sqt-click",{scope:!1,link:(t,e,i)=>{t.onclick=()=>{e.execAction(i),e.digest()}}}),e.instance().directive("sqt-model",{scope:!1,link:(e,s,n)=>{e instanceof HTMLInputElement&&(e.onkeyup=c=>{let r=s.getObject(n);r||(r=new i),r=t.set(r,n,e.value),s.setObject(n,r),s.digest()},s.subscribe({name:n,callback:i=>{i&&(e.value=t.get(i,n)||"")}}))}}),s.initialized=!0}}e.instance().controller("MainCtrl",t=>{t.setObject("todo",new class extends i{description="";priority=0});t.setObject("todos",new class extends i{list=[]}),t.setAction("foo()",t=>{console.log("clicked")}),t.setAction("add()",e=>{const i=t.getObject("todos"),s=t.getObject("todo");i&&s&&(i.list.push({description:s.description,priority:s.priority}),t.setObject("todos",i))})}),s.bootstrap();
